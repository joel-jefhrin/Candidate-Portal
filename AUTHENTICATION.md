# Candidate Authentication System

## Overview

The candidate portal now uses **dynamic authentication** that validates credentials against the PostgreSQL database through the admin portal's API.

---

## How It Works

### 1. Admin Creates Candidate

```
Admin Portal â†’ Candidates â†’ Add Candidate
â†“
System generates temporary password (e.g., "temp1234")
â†“
Candidate created in database with:
  - email: john.doe@example.com
  - tempPassword: temp1234
  - campaignId: (assigned campaign)
  - status: not_started
```

### 2. Candidate Receives Credentials

```
Email notification sent to candidate:
  - Login URL: http://localhost:3001/login
  - Email: john.doe@example.com
  - Temporary Password: temp1234
```

### 3. Candidate Logs In

```
Candidate Portal â†’ Login Form
â†“
POST /api/auth/candidate
{
  email: "john.doe@example.com",
  tempPassword: "temp1234"
}
â†“
Admin Portal validates credentials
â†“
Returns candidate data + campaign info
â†“
Candidate Portal stores session
â†“
Redirect to /interview
```

---

## API Endpoints

### Authentication

**Endpoint**: `POST /api/auth/candidate`

**Request**:
```json
{
  "email": "candidate@example.com",
  "tempPassword": "temp1234"
}
```

**Response (Success)**:
```json
{
  "id": "clx123abc",
  "firstName": "John",
  "lastName": "Doe",
  "email": "john.doe@example.com",
  "status": "not_started",
  "campaignId": "clx456def",
  "campaign": {
    "id": "clx456def",
    "name": "Frontend Developer - Q1 2024",
    "status": "active",
    "departmentId": "d1",
    "durationPerCandidate": 90,
    "questionSetIds": ["q1", "q2", "q3"],
    "passingScore": 70
  },
  "department": {
    "id": "d1",
    "name": "Engineering"
  },
  "assignedQuestions": ["q1", "q2", "q3"],
  "answers": [],
  "interviewStartedAt": null,
  "interviewCompletedAt": null
}
```

**Response (Error)**:
```json
{
  "error": "Invalid email or password"
}
```

---

### Get Questions

**Endpoint**: `GET /api/candidates/:id/questions`

**Response**:
```json
{
  "campaign": {
    "id": "clx456def",
    "name": "Frontend Developer - Q1 2024",
    "description": "...",
    "durationPerCandidate": 90,
    "questionsPerCandidate": 3,
    "passingScore": 70
  },
  "questions": [
    {
      "id": "q1",
      "title": "React Component Lifecycle",
      "description": "Explain the lifecycle methods...",
      "answerType": "essay",
      "marks": 10,
      "tags": ["react", "frontend"],
      "options": null,
      "correctAnswer": null,
      "codeTemplate": null,
      "rubric": "..."
    },
    {
      "id": "q2",
      "title": "Implement Binary Search",
      "description": "Write a function...",
      "answerType": "code_editor",
      "marks": 10,
      "codeTemplate": "function binarySearch(arr, target) {\n  // Your code here\n}",
      "options": null
    }
  ],
  "totalQuestions": 3
}
```

---

### Submit Interview

**Endpoint**: `POST /api/candidates/:id/submit`

**Request**:
```json
{
  "answers": {
    "q1": "React hooks are...",
    "q2": "function binarySearch(arr, target) { ... }",
    "q3": ["String", "Number", "Boolean"]
  },
  "interviewStartedAt": "2024-01-15T10:00:00.000Z",
  "interviewCompletedAt": "2024-01-15T11:30:00.000Z"
}
```

**Response**:
```json
{
  "message": "Interview submitted successfully",
  "candidateId": "clx123abc",
  "status": "completed",
  "score": 0
}
```

---

## Session Management

### Stored in `sessionStorage`:

```javascript
sessionStorage.setItem('candidateId', 'clx123abc');
sessionStorage.setItem('candidateEmail', 'john.doe@example.com');
sessionStorage.setItem('candidateName', 'John Doe');
sessionStorage.setItem('campaignId', 'clx456def');
sessionStorage.setItem('campaignName', 'Frontend Developer - Q1 2024');
sessionStorage.setItem('candidateData', JSON.stringify(fullData));
sessionStorage.setItem('interviewStartTime', Date.now().toString());
sessionStorage.setItem('interviewTimeTaken', '45'); // minutes
```

---

## Authentication Flow

### Login Flow

```
1. User enters email + tempPassword
   â†“
2. Candidate Portal validates format
   â†“
3. POST /api/auth/candidate
   â†“
4. Admin Portal checks database:
   - Candidate exists?
   - Password matches?
   - Campaign active?
   â†“
5. If valid:
   - Return candidate data
   - Store session
   - Redirect based on status:
     * completed â†’ /results
     * not_started/invited â†’ /interview
```

### Protected Routes

```typescript
// Every protected page checks:
useEffect(() => {
  const candidateId = sessionStorage.getItem('candidateId');
  if (!candidateId) {
    router.push('/login');
  }
}, [router]);
```

---

## Security Features

### 1. Unique Passwords
- Each candidate gets a unique `tempPassword`
- Generated by admin or auto-generated
- Format: `temp####` (e.g., temp1234, temp5678)

### 2. Campaign Validation
- Check if campaign is `active`
- Reject if campaign is `draft`, `completed`, or `archived`

### 3. Status Tracking
- `not_started` â†’ First login
- `invited` â†’ Invitation sent
- `in_progress` â†’ Interview started
- `completed` â†’ Interview submitted

### 4. Session Expiry
- Session stored in `sessionStorage`
- Cleared on logout
- Lost on browser/tab close

### 5. API Communication
- CORS configured
- JSON payload validation
- Error handling

---

## Testing Authentication

### Create Test Candidate (via Admin Portal)

1. Login to Admin Portal:
   ```
   http://localhost:3000/admin/login
   admin@example.com / admin123
   ```

2. Go to Candidates â†’ Add Candidate

3. Fill in details:
   ```
   First Name: Test
   Last Name: Candidate
   Email: test.candidate@example.com
   Department: Engineering
   Campaign: Frontend Developer - Q1 2024
   Temp Password: test123
   ```

4. Click "Create Candidate"

### Login as Candidate

1. Go to Candidate Portal:
   ```
   http://localhost:3001/login
   ```

2. Enter credentials:
   ```
   Email: test.candidate@example.com
   Password: test123
   ```

3. Click "Start Interview"

4. Should redirect to `/interview` with real questions loaded

---

## Troubleshooting

### "Invalid email or password"
- Check if candidate exists in database:
  ```bash
  npm run db:studio
  # Check Candidate table
  ```
- Verify email matches exactly (case-sensitive)
- Verify tempPassword matches

### "This campaign is not currently active"
- Campaign status must be `active`
- Check in Admin Portal â†’ Campaigns

### "Connection error"
- Admin Portal must be running on port 3000
- Check CORS configuration
- Verify `NEXT_PUBLIC_API_URL` in `.env.local`

### "Failed to load interview questions"
- Campaign must have questions assigned
- Check `questionSetIds` in campaign
- Verify questions exist in database

---

## Environment Variables

### Candidate Portal (`.env.local`)

```bash
# Admin Portal API URL
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

### Admin Portal (`.env`)

```bash
# Allow CORS from Candidate Portal
CANDIDATE_PORTAL_URL=http://localhost:3001
```

---

## Next Steps

1. **Email Integration**: Send credentials via email when candidate is created
2. **Password Reset**: Allow candidates to request password reset
3. **2FA**: Add two-factor authentication
4. **Session Timeout**: Implement automatic logout after inactivity
5. **Interview Resume**: Allow candidates to resume incomplete interviews

---

## âœ… Authentication Complete!

The candidate portal now:
- âœ… Validates against real database
- âœ… Uses unique credentials per candidate
- âœ… Loads real questions from campaigns
- âœ… Tracks interview status
- âœ… Submits answers to database

ðŸŽ‰ **Fully functional dynamic authentication!**

